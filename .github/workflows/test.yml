name: Run Tests

on:
  push:
  #pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.9"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.in-project true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: |
          poetry install --no-root --with dev

      - name: Install CMake and build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Run Python tests
        run: |
          poetry run pytest tests/ -v
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 5 ]; then
            echo "No Python test files found, skipping"
            exit 0
          fi
          exit $EXIT_CODE

      - name: Run C tests
        run: |
          EXIT_CODE=0
          C_TEST_DIRS=$(find tests -type f -name "test*.c" -exec dirname {} \; | sort -u 2>/dev/null || true)

          if [ -z "$C_TEST_DIRS" ]; then
              echo "No C test files found"
          else
              for test_dir in $C_TEST_DIRS; do
                  if [ ! -f "$test_dir/CMakeLists.txt" ]; then
                      echo "Skipping $test_dir: No CMakeLists.txt found"
                      continue
                  fi

                  BUILD_DIR="$test_dir/build"
                  mkdir -p "$BUILD_DIR"

                  echo "Building $test_dir..."
                  if ! cmake -S "$test_dir" -B "$BUILD_DIR"; then
                      echo "CMake configuration failed for $test_dir"
                      EXIT_CODE=1
                      continue
                  fi

                  if ! cmake --build "$BUILD_DIR"; then
                      echo "Build failed for $test_dir"
                      EXIT_CODE=1
                      continue
                  fi

                  echo "Running tests in $test_dir..."
                  if ! (cd "$BUILD_DIR" && ctest --output-on-failure); then
                      EXIT_CODE=1
                  fi
              done
          fi

          exit $EXIT_CODE
